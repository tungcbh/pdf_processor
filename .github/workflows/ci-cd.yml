name: CI/CD Pipeline for SQLWithIndexing

on:
  push:
    branches:
      - SQLWithIndexing
  pull_request:
    branches:
      - SQLWithIndexing

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: pdf_processor
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Docker image
        run: |
          docker build -t pdf-processor:latest .

      - name: Test Docker container
        run: |
          docker run --rm -d --name pdf-app \
            -e DB_HOST=postgres \
            -e DB_PORT=5432 \
            -e DB_NAME=pdf_processor \
            -e DB_USER=postgres \
            -e DB_PASSWORD=123456 \
            --network host \
            -p 8000:8000 \
            pdf-processor:latest
          sleep 10
          curl http://localhost:8000 || exit 1
          docker stop pdf-app

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/pdf-processor:${{ github.sha }} .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pdf-processor:${{ github.sha }}

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # Ghi SSH key vào file tạm thời
          echo "$EC2_KEY" > ec2_key.pem
          chmod 400 ec2_key.pem

          # SSH vào EC2 và deploy
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            # Đăng nhập vào Docker Hub
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            # Tạo thư mục cho volume trên EC2 (nếu chưa có)
            mkdir -p /data/postgres-data

            # Dừng và xóa container PostgreSQL cũ (nếu có)
            docker stop postgres-db || true
            docker rm postgres-db || true

            # Chạy container PostgreSQL với volume
            docker run -d --name postgres-db \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e POSTGRES_DB=pdf_processor \
              -v /data/postgres-data:/var/lib/postgresql/data \
              -p 5432:5432 \
              postgres:13

            # Dừng và xóa container ứng dụng cũ (nếu có)
            docker stop pdf-app || true
            docker rm pdf-app || true

            # Pull image mới từ Docker Hub
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/pdf-processor:${{ github.sha }}

            # Chạy container ứng dụng, kết nối tới PostgreSQL container
            docker run -d --name pdf-app \
              -e DB_HOST=localhost \
              -e DB_PORT=5432 \
              -e DB_NAME=pdf_processor \
              -e DB_USER=postgres \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -p 8000:8000 \
              ${{ secrets.DOCKERHUB_USERNAME }}/pdf-processor:${{ github.sha }}
          EOF

          # Xóa file key tạm thời
          rm ec2_key.pem
